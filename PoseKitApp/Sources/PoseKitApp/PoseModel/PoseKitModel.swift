import CoreImage
import CoreML
import CoreVideo
import Foundation
import ImageIO

public typealias PKModel = PoseKitModel

public final class PoseKitModel: Pose2DModeling, @unchecked Sendable {
    public let jointOrder: [Joint] = Joint.coco17

    public static let identifier = "PoseKitModel"
    public static let version = "1.0"

    private static let hmThreshold: Float = 0.1
    private static let modelFileName = "pkmodel"
    private static let modelPackageExtension = "mlpackage"
    private static let modelCompiledExtension = "mlmodelc"
    private static let modelRelativePaths = [
        "Sources/PoseKitApp/Resources/Models/pkmodel.mlmodelc",
        "Resources/Models/pkmodel.mlmodelc",
        "pkmodel.mlmodelc",
        "Sources/PoseKitApp/Resources/Models/pkmodel.mlpackage",
        "Resources/Models/pkmodel.mlpackage",
        "pkmodel.mlpackage",
    ]

    private static let centerWeight: [Float] = [
        0.027979, 0.028538, 0.029106, 0.029682, 0.030265, 0.030854, 0.031447, 0.032040,
        0.032632, 0.033220, 0.033801, 0.034371, 0.034925, 0.035460, 0.035971, 0.036454,
        0.036903, 0.037313, 0.037681, 0.038001, 0.038269, 0.038481, 0.038635, 0.038728,
        0.038760, 0.038728, 0.038635, 0.038481, 0.038269, 0.038001, 0.037681, 0.037313,
        0.036903, 0.036454, 0.035971, 0.035460, 0.034925, 0.034371, 0.033801, 0.033220,
        0.032632, 0.032040, 0.031447, 0.030854, 0.030265, 0.029682, 0.029106, 0.028538,
        0.028538, 0.029132, 0.029737, 0.030354, 0.030979, 0.031613, 0.032252, 0.032894,
        0.033537, 0.034177, 0.034812, 0.035436, 0.036046, 0.036637, 0.037203, 0.037738,
        0.038239, 0.038697, 0.039109, 0.039468, 0.039769, 0.040008, 0.040182, 0.040287,
        0.040323, 0.040287, 0.040182, 0.040008, 0.039769, 0.039468, 0.039109, 0.038697,
        0.038239, 0.037738, 0.037203, 0.036637, 0.036046, 0.035436, 0.034812, 0.034177,
        0.033537, 0.032894, 0.032252, 0.031613, 0.030979, 0.030354, 0.029737, 0.029132,
        0.029106, 0.029737, 0.030383, 0.031043, 0.031714, 0.032395, 0.033085, 0.033781,
        0.034479, 0.035178, 0.035872, 0.036558, 0.037230, 0.037883, 0.038512, 0.039109,
        0.039668, 0.040182, 0.040645, 0.041049, 0.041390, 0.041660, 0.041857, 0.041977,
        0.042017, 0.041977, 0.041857, 0.041660, 0.041390, 0.041049, 0.040645, 0.040182,
        0.039668, 0.039109, 0.038512, 0.037883, 0.037230, 0.036558, 0.035872, 0.035178,
        0.034479, 0.033781, 0.033085, 0.032395, 0.031714, 0.031043, 0.030383, 0.029737,
        0.029682, 0.030354, 0.031043, 0.031748, 0.032468, 0.033201, 0.033946, 0.034700,
        0.035460, 0.036223, 0.036984, 0.037738, 0.038481, 0.039206, 0.039905, 0.040572,
        0.041199, 0.041778, 0.042301, 0.042759, 0.043145, 0.043453, 0.043678, 0.043814,
        0.043860, 0.043814, 0.043678, 0.043453, 0.043145, 0.042759, 0.042301, 0.041778,
        0.041199, 0.040572, 0.039905, 0.039206, 0.038481, 0.037738, 0.036984, 0.036223,
        0.035460, 0.034700, 0.033946, 0.033201, 0.032468, 0.031748, 0.031043, 0.030354,
        0.030265, 0.030979, 0.031714, 0.032468, 0.033240, 0.034030, 0.034834, 0.035652,
        0.036480, 0.037313, 0.038149, 0.038981, 0.039803, 0.040608, 0.041390, 0.042138,
        0.042844, 0.043498, 0.044091, 0.044612, 0.045053, 0.045406, 0.045663, 0.045819,
        0.045872, 0.045819, 0.045663, 0.045406, 0.045053, 0.044612, 0.044091, 0.043498,
        0.042844, 0.042138, 0.041390, 0.040608, 0.039803, 0.038981, 0.038149, 0.037313,
        0.036480, 0.035652, 0.034834, 0.034030, 0.033240, 0.032468, 0.031714, 0.030979,
        0.030854, 0.031613, 0.032395, 0.033201, 0.034030, 0.034880, 0.035749, 0.036637,
        0.037538, 0.038451, 0.039369, 0.040287, 0.041199, 0.042097, 0.042972, 0.043814,
        0.044612, 0.045355, 0.046030, 0.046627, 0.047133, 0.047539, 0.047836, 0.048016,
        0.048077, 0.048016, 0.047836, 0.047539, 0.047133, 0.046627, 0.046030, 0.045355,
        0.044612, 0.043814, 0.042972, 0.042097, 0.041199, 0.040287, 0.039369, 0.038451,
        0.037538, 0.036637, 0.035749, 0.034880, 0.034030, 0.033201, 0.032395, 0.031613,
        0.031447, 0.032252, 0.033085, 0.033946, 0.034834, 0.035749, 0.036689, 0.037652,
        0.038635, 0.039634, 0.040645, 0.041660, 0.042674, 0.043678, 0.044660, 0.045611,
        0.046517, 0.047364, 0.048138, 0.048824, 0.049409, 0.049880, 0.050224, 0.050434,
        0.050505, 0.050434, 0.050224, 0.049880, 0.049409, 0.048824, 0.048138, 0.047364,
        0.046517, 0.045611, 0.044660, 0.043678, 0.042674, 0.041660, 0.040645, 0.039634,
        0.038635, 0.037652, 0.036689, 0.035749, 0.034834, 0.033946, 0.033085, 0.032252,
        0.032040, 0.032894, 0.033781, 0.034700, 0.035652, 0.036637, 0.037652, 0.038697,
        0.039769, 0.040864, 0.041977, 0.043102, 0.044231, 0.045355, 0.046462, 0.047539,
        0.048571, 0.049542, 0.050434, 0.051229, 0.051910, 0.052459, 0.052862, 0.053108,
        0.053191, 0.053108, 0.052862, 0.052459, 0.051910, 0.051229, 0.050434, 0.049542,
        0.048571, 0.047539, 0.046462, 0.045355, 0.044231, 0.043102, 0.041977, 0.040864,
        0.039769, 0.038697, 0.037652, 0.036637, 0.035652, 0.034700, 0.033781, 0.032894,
        0.032632, 0.033537, 0.034479, 0.035460, 0.036480, 0.037538, 0.038635, 0.039769,
        0.040938, 0.042138, 0.043365, 0.044612, 0.045872, 0.047133, 0.048384, 0.049609,
        0.050791, 0.051910, 0.052944, 0.053870, 0.054667, 0.055313, 0.055790, 0.056081,
        0.056180, 0.056081, 0.055790, 0.055313, 0.054667, 0.053870, 0.052944, 0.051910,
        0.050791, 0.049609, 0.048384, 0.047133, 0.045872, 0.044612, 0.043365, 0.042138,
        0.040938, 0.039769, 0.038635, 0.037538, 0.036480, 0.035460, 0.034479, 0.033537,
        0.033220, 0.034177, 0.035178, 0.036223, 0.037313, 0.038451, 0.039634, 0.040864,
        0.042138, 0.043453, 0.044806, 0.046191, 0.047598, 0.049017, 0.050434, 0.051833,
        0.053191, 0.054487, 0.055693, 0.056781, 0.057723, 0.058490, 0.059057, 0.059406,
        0.059524, 0.059406, 0.059057, 0.058490, 0.057723, 0.056781, 0.055693, 0.054487,
        0.053191, 0.051833, 0.050434, 0.049017, 0.047598, 0.046191, 0.044806, 0.043453,
        0.042138, 0.040864, 0.039634, 0.038451, 0.037313, 0.036223, 0.035178, 0.034177,
        0.033801, 0.034812, 0.035872, 0.036984, 0.038149, 0.039369, 0.040645, 0.041977,
        0.043365, 0.044806, 0.046298, 0.047836, 0.049409, 0.051009, 0.052619, 0.054220,
        0.055790, 0.057298, 0.058715, 0.060002, 0.061124, 0.062043, 0.062727, 0.063149,
        0.063291, 0.063149, 0.062727, 0.062043, 0.061124, 0.060002, 0.058715, 0.057298,
        0.055790, 0.054220, 0.052619, 0.051009, 0.049409, 0.047836, 0.046298, 0.044806,
        0.043365, 0.041977, 0.040645, 0.039369, 0.038149, 0.036984, 0.035872, 0.034812,
        0.034371, 0.035436, 0.036558, 0.037738, 0.038981, 0.040287, 0.041660, 0.043102,
        0.044612, 0.046191, 0.047836, 0.049542, 0.051304, 0.053108, 0.054941, 0.056781,
        0.058602, 0.060369, 0.062043, 0.063579, 0.064929, 0.066043, 0.066876, 0.067393,
        0.067568, 0.067393, 0.066876, 0.066043, 0.064929, 0.063579, 0.062043, 0.060369,
        0.058602, 0.056781, 0.054941, 0.053108, 0.051304, 0.049542, 0.047836, 0.046191,
        0.044612, 0.043102, 0.041660, 0.040287, 0.038981, 0.037738, 0.036558, 0.035436,
        0.034925, 0.036046, 0.037230, 0.038481, 0.039803, 0.041199, 0.042674, 0.044231,
        0.045872, 0.047598, 0.049409, 0.051304, 0.053275, 0.055313, 0.057404, 0.059524,
        0.061644, 0.063725, 0.065719, 0.067568, 0.069208, 0.070575, 0.071605, 0.072246,
        0.072464, 0.072246, 0.071605, 0.070575, 0.069208, 0.067568, 0.065719, 0.063725,
        0.061644, 0.059524, 0.057404, 0.055313, 0.053275, 0.051304, 0.049409, 0.047598,
        0.045872, 0.044231, 0.042674, 0.041199, 0.039803, 0.038481, 0.037230, 0.036046,
        0.035460, 0.036637, 0.037883, 0.039206, 0.040608, 0.042097, 0.043678, 0.045355,
        0.047133, 0.049017, 0.051009, 0.053108, 0.055313, 0.057616, 0.060002, 0.062451,
        0.064929, 0.067393, 0.069784, 0.072030, 0.074048, 0.075748, 0.077040, 0.077849,
        0.078125, 0.077849, 0.077040, 0.075748, 0.074048, 0.072030, 0.069784, 0.067393,
        0.064929, 0.062451, 0.060002, 0.057616, 0.055313, 0.053108, 0.051009, 0.049017,
        0.047133, 0.045355, 0.043678, 0.042097, 0.040608, 0.039206, 0.037883, 0.036637,
        0.035971, 0.037203, 0.038512, 0.039905, 0.041390, 0.042972, 0.044660, 0.046462,
        0.048384, 0.050434, 0.052619, 0.054941, 0.057404, 0.060002, 0.062727, 0.065558,
        0.068464, 0.071395, 0.074284, 0.077040, 0.079552, 0.081697, 0.083347, 0.084389,
        0.084746, 0.084389, 0.083347, 0.081697, 0.079552, 0.077040, 0.074284, 0.071395,
        0.068464, 0.065558, 0.062727, 0.060002, 0.057404, 0.054941, 0.052619, 0.050434,
        0.048384, 0.046462, 0.044660, 0.042972, 0.041390, 0.039905, 0.038512, 0.037203,
        0.036454, 0.037738, 0.039109, 0.040572, 0.042138, 0.043814, 0.045611, 0.047539,
        0.049609, 0.051833, 0.054220, 0.056781, 0.059524, 0.062451, 0.065558, 0.068833,
        0.072246, 0.075748, 0.079260, 0.082674, 0.085845, 0.088599, 0.090748, 0.092120,
        0.092593, 0.092120, 0.090748, 0.088599, 0.085845, 0.082674, 0.079260, 0.075748,
        0.072246, 0.068833, 0.065558, 0.062451, 0.059524, 0.056781, 0.054220, 0.051833,
        0.049609, 0.047539, 0.045611, 0.043814, 0.042138, 0.040572, 0.039109, 0.037738,
        0.036903, 0.038239, 0.039668, 0.041199, 0.042844, 0.044612, 0.046517, 0.048571,
        0.050791, 0.053191, 0.055790, 0.058602, 0.061644, 0.064929, 0.068464, 0.072246,
        0.076256, 0.080450, 0.084746, 0.089016, 0.093073, 0.096674, 0.099540, 0.101397,
        0.102041, 0.101397, 0.099540, 0.096674, 0.093073, 0.089016, 0.084746, 0.080450,
        0.076256, 0.072246, 0.068464, 0.064929, 0.061644, 0.058602, 0.055790, 0.053191,
        0.050791, 0.048571, 0.046517, 0.044612, 0.042844, 0.041199, 0.039668, 0.038239,
        0.037313, 0.038697, 0.040182, 0.041778, 0.043498, 0.045355, 0.047364, 0.049542,
        0.051910, 0.054487, 0.057298, 0.060369, 0.063725, 0.067393, 0.071395, 0.075748,
        0.080450, 0.085474, 0.090748, 0.096132, 0.101397, 0.106205, 0.110131, 0.112726,
        0.113636, 0.112726, 0.110131, 0.106205, 0.101397, 0.096132, 0.090748, 0.085474,
        0.080450, 0.075748, 0.071395, 0.067393, 0.063725, 0.060369, 0.057298, 0.054487,
        0.051910, 0.049542, 0.047364, 0.045355, 0.043498, 0.041778, 0.040182, 0.038697,
        0.037681, 0.039109, 0.040645, 0.042301, 0.044091, 0.046030, 0.048138, 0.050434,
        0.052944, 0.055693, 0.058715, 0.062043, 0.065719, 0.069784, 0.074284, 0.079260,
        0.084746, 0.090748, 0.097226, 0.104056, 0.110974, 0.117534, 0.123084, 0.126859,
        0.128205, 0.126859, 0.123084, 0.117534, 0.110974, 0.104056, 0.097226, 0.090748,
        0.084746, 0.079260, 0.074284, 0.069784, 0.065719, 0.062043, 0.058715, 0.055693,
        0.052944, 0.050434, 0.048138, 0.046030, 0.044091, 0.042301, 0.040645, 0.039109,
        0.038001, 0.039468, 0.041049, 0.042759, 0.044612, 0.046627, 0.048824, 0.051229,
        0.053870, 0.056781, 0.060002, 0.063579, 0.067568, 0.072030, 0.077040, 0.082674,
        0.089016, 0.096132, 0.104056, 0.112726, 0.121905, 0.131045, 0.139176, 0.144948,
        0.147059, 0.144948, 0.139176, 0.131045, 0.121905, 0.112726, 0.104056, 0.096132,
        0.089016, 0.082674, 0.077040, 0.072030, 0.067568, 0.063579, 0.060002, 0.056781,
        0.053870, 0.051229, 0.048824, 0.046627, 0.044612, 0.042759, 0.041049, 0.039468,
        0.038269, 0.039769, 0.041390, 0.043145, 0.045053, 0.047133, 0.049409, 0.051910,
        0.054667, 0.057723, 0.061124, 0.064929, 0.069208, 0.074048, 0.079552, 0.085845,
        0.093073, 0.101397, 0.110974, 0.121905, 0.134105, 0.147059, 0.159435, 0.168830,
        0.172414, 0.168830, 0.159435, 0.147059, 0.134105, 0.121905, 0.110974, 0.101397,
        0.093073, 0.085845, 0.079552, 0.074048, 0.069208, 0.064929, 0.061124, 0.057723,
        0.054667, 0.051910, 0.049409, 0.047133, 0.045053, 0.043145, 0.041390, 0.039769,
        0.038481, 0.040008, 0.041660, 0.043453, 0.045406, 0.047539, 0.049880, 0.052459,
        0.055313, 0.058490, 0.062043, 0.066043, 0.070575, 0.075748, 0.081697, 0.088599,
        0.096674, 0.106205, 0.117534, 0.131045, 0.147059, 0.165491, 0.184995, 0.201520,
        0.208333, 0.201520, 0.184995, 0.165491, 0.147059, 0.131045, 0.117534, 0.106205,
        0.096674, 0.088599, 0.081697, 0.075748, 0.070575, 0.066043, 0.062043, 0.058490,
        0.055313, 0.052459, 0.049880, 0.047539, 0.045406, 0.043453, 0.041660, 0.040008,
        0.038635, 0.040182, 0.041857, 0.043678, 0.045663, 0.047836, 0.050224, 0.052862,
        0.055790, 0.059057, 0.062727, 0.066876, 0.071605, 0.077040, 0.083347, 0.090748,
        0.099540, 0.110131, 0.123084, 0.139176, 0.159435, 0.184995, 0.216056, 0.247766,
        0.263158, 0.247766, 0.216056, 0.184995, 0.159435, 0.139176, 0.123084, 0.110131,
        0.099540, 0.090748, 0.083347, 0.077040, 0.071605, 0.066876, 0.062727, 0.059057,
        0.055790, 0.052862, 0.050224, 0.047836, 0.045663, 0.043678, 0.041857, 0.040182,
        0.038728, 0.040287, 0.041977, 0.043814, 0.045819, 0.048016, 0.050434, 0.053108,
        0.056081, 0.059406, 0.063149, 0.067393, 0.072246, 0.077849, 0.084389, 0.092120,
        0.101397, 0.112726, 0.126859, 0.144948, 0.168830, 0.201520, 0.247766, 0.311118,
        0.357143, 0.311118, 0.247766, 0.201520, 0.168830, 0.144948, 0.126859, 0.112726,
        0.101397, 0.092120, 0.084389, 0.077849, 0.072246, 0.067393, 0.063149, 0.059406,
        0.056081, 0.053108, 0.050434, 0.048016, 0.045819, 0.043814, 0.041977, 0.040287,
        0.038760, 0.040323, 0.042017, 0.043860, 0.045872, 0.048077, 0.050505, 0.053191,
        0.056180, 0.059524, 0.063291, 0.067568, 0.072464, 0.078125, 0.084746, 0.092593,
        0.102041, 0.113636, 0.128205, 0.147059, 0.172414, 0.208333, 0.263158, 0.357143,
        0.555556, 0.357143, 0.263158, 0.208333, 0.172414, 0.147059, 0.128205, 0.113636,
        0.102041, 0.092593, 0.084746, 0.078125, 0.072464, 0.067568, 0.063291, 0.059524,
        0.056180, 0.053191, 0.050505, 0.048077, 0.045872, 0.043860, 0.042017, 0.040323,
        0.038728, 0.040287, 0.041977, 0.043814, 0.045819, 0.048016, 0.050434, 0.053108,
        0.056081, 0.059406, 0.063149, 0.067393, 0.072246, 0.077849, 0.084389, 0.092120,
        0.101397, 0.112726, 0.126859, 0.144948, 0.168830, 0.201520, 0.247766, 0.311118,
        0.357143, 0.311118, 0.247766, 0.201520, 0.168830, 0.144948, 0.126859, 0.112726,
        0.101397, 0.092120, 0.084389, 0.077849, 0.072246, 0.067393, 0.063149, 0.059406,
        0.056081, 0.053108, 0.050434, 0.048016, 0.045819, 0.043814, 0.041977, 0.040287,
        0.038635, 0.040182, 0.041857, 0.043678, 0.045663, 0.047836, 0.050224, 0.052862,
        0.055790, 0.059057, 0.062727, 0.066876, 0.071605, 0.077040, 0.083347, 0.090748,
        0.099540, 0.110131, 0.123084, 0.139176, 0.159435, 0.184995, 0.216056, 0.247766,
        0.263158, 0.247766, 0.216056, 0.184995, 0.159435, 0.139176, 0.123084, 0.110131,
        0.099540, 0.090748, 0.083347, 0.077040, 0.071605, 0.066876, 0.062727, 0.059057,
        0.055790, 0.052862, 0.050224, 0.047836, 0.045663, 0.043678, 0.041857, 0.040182,
        0.038481, 0.040008, 0.041660, 0.043453, 0.045406, 0.047539, 0.049880, 0.052459,
        0.055313, 0.058490, 0.062043, 0.066043, 0.070575, 0.075748, 0.081697, 0.088599,
        0.096674, 0.106205, 0.117534, 0.131045, 0.147059, 0.165491, 0.184995, 0.201520,
        0.208333, 0.201520, 0.184995, 0.165491, 0.147059, 0.131045, 0.117534, 0.106205,
        0.096674, 0.088599, 0.081697, 0.075748, 0.070575, 0.066043, 0.062043, 0.058490,
        0.055313, 0.052459, 0.049880, 0.047539, 0.045406, 0.043453, 0.041660, 0.040008,
        0.038269, 0.039769, 0.041390, 0.043145, 0.045053, 0.047133, 0.049409, 0.051910,
        0.054667, 0.057723, 0.061124, 0.064929, 0.069208, 0.074048, 0.079552, 0.085845,
        0.093073, 0.101397, 0.110974, 0.121905, 0.134105, 0.147059, 0.159435, 0.168830,
        0.172414, 0.168830, 0.159435, 0.147059, 0.134105, 0.121905, 0.110974, 0.101397,
        0.093073, 0.085845, 0.079552, 0.074048, 0.069208, 0.064929, 0.061124, 0.057723,
        0.054667, 0.051910, 0.049409, 0.047133, 0.045053, 0.043145, 0.041390, 0.039769,
        0.038001, 0.039468, 0.041049, 0.042759, 0.044612, 0.046627, 0.048824, 0.051229,
        0.053870, 0.056781, 0.060002, 0.063579, 0.067568, 0.072030, 0.077040, 0.082674,
        0.089016, 0.096132, 0.104056, 0.112726, 0.121905, 0.131045, 0.139176, 0.144948,
        0.147059, 0.144948, 0.139176, 0.131045, 0.121905, 0.112726, 0.104056, 0.096132,
        0.089016, 0.082674, 0.077040, 0.072030, 0.067568, 0.063579, 0.060002, 0.056781,
        0.053870, 0.051229, 0.048824, 0.046627, 0.044612, 0.042759, 0.041049, 0.039468,
        0.037681, 0.039109, 0.040645, 0.042301, 0.044091, 0.046030, 0.048138, 0.050434,
        0.052944, 0.055693, 0.058715, 0.062043, 0.065719, 0.069784, 0.074284, 0.079260,
        0.084746, 0.090748, 0.097226, 0.104056, 0.110974, 0.117534, 0.123084, 0.126859,
        0.128205, 0.126859, 0.123084, 0.117534, 0.110974, 0.104056, 0.097226, 0.090748,
        0.084746, 0.079260, 0.074284, 0.069784, 0.065719, 0.062043, 0.058715, 0.055693,
        0.052944, 0.050434, 0.048138, 0.046030, 0.044091, 0.042301, 0.040645, 0.039109,
        0.037313, 0.038697, 0.040182, 0.041778, 0.043498, 0.045355, 0.047364, 0.049542,
        0.051910, 0.054487, 0.057298, 0.060369, 0.063725, 0.067393, 0.071395, 0.075748,
        0.080450, 0.085474, 0.090748, 0.096132, 0.101397, 0.106205, 0.110131, 0.112726,
        0.113636, 0.112726, 0.110131, 0.106205, 0.101397, 0.096132, 0.090748, 0.085474,
        0.080450, 0.075748, 0.071395, 0.067393, 0.063725, 0.060369, 0.057298, 0.054487,
        0.051910, 0.049542, 0.047364, 0.045355, 0.043498, 0.041778, 0.040182, 0.038697,
        0.036903, 0.038239, 0.039668, 0.041199, 0.042844, 0.044612, 0.046517, 0.048571,
        0.050791, 0.053191, 0.055790, 0.058602, 0.061644, 0.064929, 0.068464, 0.072246,
        0.076256, 0.080450, 0.084746, 0.089016, 0.093073, 0.096674, 0.099540, 0.101397,
        0.102041, 0.101397, 0.099540, 0.096674, 0.093073, 0.089016, 0.084746, 0.080450,
        0.076256, 0.072246, 0.068464, 0.064929, 0.061644, 0.058602, 0.055790, 0.053191,
        0.050791, 0.048571, 0.046517, 0.044612, 0.042844, 0.041199, 0.039668, 0.038239,
        0.036454, 0.037738, 0.039109, 0.040572, 0.042138, 0.043814, 0.045611, 0.047539,
        0.049609, 0.051833, 0.054220, 0.056781, 0.059524, 0.062451, 0.065558, 0.068833,
        0.072246, 0.075748, 0.079260, 0.082674, 0.085845, 0.088599, 0.090748, 0.092120,
        0.092593, 0.092120, 0.090748, 0.088599, 0.085845, 0.082674, 0.079260, 0.075748,
        0.072246, 0.068833, 0.065558, 0.062451, 0.059524, 0.056781, 0.054220, 0.051833,
        0.049609, 0.047539, 0.045611, 0.043814, 0.042138, 0.040572, 0.039109, 0.037738,
        0.035971, 0.037203, 0.038512, 0.039905, 0.041390, 0.042972, 0.044660, 0.046462,
        0.048384, 0.050434, 0.052619, 0.054941, 0.057404, 0.060002, 0.062727, 0.065558,
        0.068464, 0.071395, 0.074284, 0.077040, 0.079552, 0.081697, 0.083347, 0.084389,
        0.084746, 0.084389, 0.083347, 0.081697, 0.079552, 0.077040, 0.074284, 0.071395,
        0.068464, 0.065558, 0.062727, 0.060002, 0.057404, 0.054941, 0.052619, 0.050434,
        0.048384, 0.046462, 0.044660, 0.042972, 0.041390, 0.039905, 0.038512, 0.037203,
        0.035460, 0.036637, 0.037883, 0.039206, 0.040608, 0.042097, 0.043678, 0.045355,
        0.047133, 0.049017, 0.051009, 0.053108, 0.055313, 0.057616, 0.060002, 0.062451,
        0.064929, 0.067393, 0.069784, 0.072030, 0.074048, 0.075748, 0.077040, 0.077849,
        0.078125, 0.077849, 0.077040, 0.075748, 0.074048, 0.072030, 0.069784, 0.067393,
        0.064929, 0.062451, 0.060002, 0.057616, 0.055313, 0.053108, 0.051009, 0.049017,
        0.047133, 0.045355, 0.043678, 0.042097, 0.040608, 0.039206, 0.037883, 0.036637,
        0.034925, 0.036046, 0.037230, 0.038481, 0.039803, 0.041199, 0.042674, 0.044231,
        0.045872, 0.047598, 0.049409, 0.051304, 0.053275, 0.055313, 0.057404, 0.059524,
        0.061644, 0.063725, 0.065719, 0.067568, 0.069208, 0.070575, 0.071605, 0.072246,
        0.072464, 0.072246, 0.071605, 0.070575, 0.069208, 0.067568, 0.065719, 0.063725,
        0.061644, 0.059524, 0.057404, 0.055313, 0.053275, 0.051304, 0.049409, 0.047598,
        0.045872, 0.044231, 0.042674, 0.041199, 0.039803, 0.038481, 0.037230, 0.036046,
        0.034371, 0.035436, 0.036558, 0.037738, 0.038981, 0.040287, 0.041660, 0.043102,
        0.044612, 0.046191, 0.047836, 0.049542, 0.051304, 0.053108, 0.054941, 0.056781,
        0.058602, 0.060369, 0.062043, 0.063579, 0.064929, 0.066043, 0.066876, 0.067393,
        0.067568, 0.067393, 0.066876, 0.066043, 0.064929, 0.063579, 0.062043, 0.060369,
        0.058602, 0.056781, 0.054941, 0.053108, 0.051304, 0.049542, 0.047836, 0.046191,
        0.044612, 0.043102, 0.041660, 0.040287, 0.038981, 0.037738, 0.036558, 0.035436,
        0.033801, 0.034812, 0.035872, 0.036984, 0.038149, 0.039369, 0.040645, 0.041977,
        0.043365, 0.044806, 0.046298, 0.047836, 0.049409, 0.051009, 0.052619, 0.054220,
        0.055790, 0.057298, 0.058715, 0.060002, 0.061124, 0.062043, 0.062727, 0.063149,
        0.063291, 0.063149, 0.062727, 0.062043, 0.061124, 0.060002, 0.058715, 0.057298,
        0.055790, 0.054220, 0.052619, 0.051009, 0.049409, 0.047836, 0.046298, 0.044806,
        0.043365, 0.041977, 0.040645, 0.039369, 0.038149, 0.036984, 0.035872, 0.034812,
        0.033220, 0.034177, 0.035178, 0.036223, 0.037313, 0.038451, 0.039634, 0.040864,
        0.042138, 0.043453, 0.044806, 0.046191, 0.047598, 0.049017, 0.050434, 0.051833,
        0.053191, 0.054487, 0.055693, 0.056781, 0.057723, 0.058490, 0.059057, 0.059406,
        0.059524, 0.059406, 0.059057, 0.058490, 0.057723, 0.056781, 0.055693, 0.054487,
        0.053191, 0.051833, 0.050434, 0.049017, 0.047598, 0.046191, 0.044806, 0.043453,
        0.042138, 0.040864, 0.039634, 0.038451, 0.037313, 0.036223, 0.035178, 0.034177,
        0.032632, 0.033537, 0.034479, 0.035460, 0.036480, 0.037538, 0.038635, 0.039769,
        0.040938, 0.042138, 0.043365, 0.044612, 0.045872, 0.047133, 0.048384, 0.049609,
        0.050791, 0.051910, 0.052944, 0.053870, 0.054667, 0.055313, 0.055790, 0.056081,
        0.056180, 0.056081, 0.055790, 0.055313, 0.054667, 0.053870, 0.052944, 0.051910,
        0.050791, 0.049609, 0.048384, 0.047133, 0.045872, 0.044612, 0.043365, 0.042138,
        0.040938, 0.039769, 0.038635, 0.037538, 0.036480, 0.035460, 0.034479, 0.033537,
        0.032040, 0.032894, 0.033781, 0.034700, 0.035652, 0.036637, 0.037652, 0.038697,
        0.039769, 0.040864, 0.041977, 0.043102, 0.044231, 0.045355, 0.046462, 0.047539,
        0.048571, 0.049542, 0.050434, 0.051229, 0.051910, 0.052459, 0.052862, 0.053108,
        0.053191, 0.053108, 0.052862, 0.052459, 0.051910, 0.051229, 0.050434, 0.049542,
        0.048571, 0.047539, 0.046462, 0.045355, 0.044231, 0.043102, 0.041977, 0.040864,
        0.039769, 0.038697, 0.037652, 0.036637, 0.035652, 0.034700, 0.033781, 0.032894,
        0.031447, 0.032252, 0.033085, 0.033946, 0.034834, 0.035749, 0.036689, 0.037652,
        0.038635, 0.039634, 0.040645, 0.041660, 0.042674, 0.043678, 0.044660, 0.045611,
        0.046517, 0.047364, 0.048138, 0.048824, 0.049409, 0.049880, 0.050224, 0.050434,
        0.050505, 0.050434, 0.050224, 0.049880, 0.049409, 0.048824, 0.048138, 0.047364,
        0.046517, 0.045611, 0.044660, 0.043678, 0.042674, 0.041660, 0.040645, 0.039634,
        0.038635, 0.037652, 0.036689, 0.035749, 0.034834, 0.033946, 0.033085, 0.032252,
        0.030854, 0.031613, 0.032395, 0.033201, 0.034030, 0.034880, 0.035749, 0.036637,
        0.037538, 0.038451, 0.039369, 0.040287, 0.041199, 0.042097, 0.042972, 0.043814,
        0.044612, 0.045355, 0.046030, 0.046627, 0.047133, 0.047539, 0.047836, 0.048016,
        0.048077, 0.048016, 0.047836, 0.047539, 0.047133, 0.046627, 0.046030, 0.045355,
        0.044612, 0.043814, 0.042972, 0.042097, 0.041199, 0.040287, 0.039369, 0.038451,
        0.037538, 0.036637, 0.035749, 0.034880, 0.034030, 0.033201, 0.032395, 0.031613,
        0.030265, 0.030979, 0.031714, 0.032468, 0.033240, 0.034030, 0.034834, 0.035652,
        0.036480, 0.037313, 0.038149, 0.038981, 0.039803, 0.040608, 0.041390, 0.042138,
        0.042844, 0.043498, 0.044091, 0.044612, 0.045053, 0.045406, 0.045663, 0.045819,
        0.045872, 0.045819, 0.045663, 0.045406, 0.045053, 0.044612, 0.044091, 0.043498,
        0.042844, 0.042138, 0.041390, 0.040608, 0.039803, 0.038981, 0.038149, 0.037313,
        0.036480, 0.035652, 0.034834, 0.034030, 0.033240, 0.032468, 0.031714, 0.030979,
        0.029682, 0.030354, 0.031043, 0.031748, 0.032468, 0.033201, 0.033946, 0.034700,
        0.035460, 0.036223, 0.036984, 0.037738, 0.038481, 0.039206, 0.039905, 0.040572,
        0.041199, 0.041778, 0.042301, 0.042759, 0.043145, 0.043453, 0.043678, 0.043814,
        0.043860, 0.043814, 0.043678, 0.043453, 0.043145, 0.042759, 0.042301, 0.041778,
        0.041199, 0.040572, 0.039905, 0.039206, 0.038481, 0.037738, 0.036984, 0.036223,
        0.035460, 0.034700, 0.033946, 0.033201, 0.032468, 0.031748, 0.031043, 0.030354,
        0.029106, 0.029737, 0.030383, 0.031043, 0.031714, 0.032395, 0.033085, 0.033781,
        0.034479, 0.035178, 0.035872, 0.036558, 0.037230, 0.037883, 0.038512, 0.039109,
        0.039668, 0.040182, 0.040645, 0.041049, 0.041390, 0.041660, 0.041857, 0.041977,
        0.042017, 0.041977, 0.041857, 0.041660, 0.041390, 0.041049, 0.040645, 0.040182,
        0.039668, 0.039109, 0.038512, 0.037883, 0.037230, 0.036558, 0.035872, 0.035178,
        0.034479, 0.033781, 0.033085, 0.032395, 0.031714, 0.031043, 0.030383, 0.029737,
        0.028538, 0.029132, 0.029737, 0.030354, 0.030979, 0.031613, 0.032252, 0.032894,
        0.033537, 0.034177, 0.034812, 0.035436, 0.036046, 0.036637, 0.037203, 0.037738,
        0.038239, 0.038697, 0.039109, 0.039468, 0.039769, 0.040008, 0.040182, 0.040287,
        0.040323, 0.040287, 0.040182, 0.040008, 0.039769, 0.039468, 0.039109, 0.038697,
        0.038239, 0.037738, 0.037203, 0.036637, 0.036046, 0.035436, 0.034812, 0.034177,
        0.033537, 0.032894, 0.032252, 0.031613, 0.030979, 0.030354, 0.029737, 0.029132,
    ]

    private let queue = DispatchQueue(label: "dev.posekit.pkmodel.infer")
    private let model: MLModel
    private let ciContext: CIContext
    private let inputWidth: Int
    private let inputHeight: Int
    private let inputPixelFormat: OSType

    private var reusablePixelBuffer: CVPixelBuffer?

    private final class SendablePixelBuffer: @unchecked Sendable {
        let buffer: CVPixelBuffer

        init(_ buffer: CVPixelBuffer) {
            self.buffer = buffer
        }
    }

    public convenience init() {
        do {
            try self.init(modelURL: nil, configuration: MLModelConfiguration())
        } catch {
            preconditionFailure("PoseKitModel failed to load: \(error)")
        }
    }

    public init(
        modelURL: URL? = nil,
        configuration: MLModelConfiguration = MLModelConfiguration()
    ) throws {
        let resolvedURL = try Self.resolveModelURL(candidate: modelURL)
        model = try Self.loadModel(url: resolvedURL, configuration: configuration)

        guard let inputDescription = model.modelDescription.inputDescriptionsByName["input"]
            ?? model.modelDescription.inputDescriptionsByName.values.first else {
            throw PoseModelError.invalidInput
        }

        switch inputDescription.type {
        case .image:
            let constraint = inputDescription.imageConstraint
            inputWidth = constraint?.pixelsWide ?? 192
            inputHeight = constraint?.pixelsHigh ?? 192
            inputPixelFormat = constraint?.pixelFormatType ?? kCVPixelFormatType_32BGRA
        default:
            throw PoseModelError.invalidInput
        }

        ciContext = CIContext(options: [.useSoftwareRenderer: false])
    }

    public func infer(
        pixelBuffer: CVPixelBuffer,
        orientation: CGImagePropertyOrientation,
        timestamp: TimeInterval
    ) async throws -> [Keypoint2D] {
        let bufferBox = SendablePixelBuffer(pixelBuffer)
        return try await withCheckedThrowingContinuation { continuation in
            queue.async { [self] in
                do {
                    let (inputBuffer, mapping) = try prepareInput(
                        pixelBuffer: bufferBox.buffer,
                        orientation: orientation
                    )
                    let features = try MLDictionaryFeatureProvider(dictionary: [
                        "input": MLFeatureValue(pixelBuffer: inputBuffer)
                    ])
                    let output = try model.prediction(from: features)
                    let keypoints = try decodeOutput(output, mapping: mapping)
                    continuation.resume(returning: keypoints)
                } catch {
                    continuation.resume(throwing: error)
                }
            }
        }
    }

    private static func resolveModelURL(candidate: URL?) throws -> URL {
        if let candidate, FileManager.default.fileExists(atPath: candidate.path) {
            return candidate
        }

        let cwd = URL(fileURLWithPath: FileManager.default.currentDirectoryPath)
        for relativePath in modelRelativePaths {
            let relativeURL = URL(fileURLWithPath: relativePath, relativeTo: cwd)
                .standardizedFileURL
            if FileManager.default.fileExists(atPath: relativeURL.path) {
                return relativeURL
            }
        }

        let bundles: [Bundle] = [Bundle.main, Bundle.module]
        let subdirectories: [String?] = ["Models", "Resources/Models", nil]
        for bundle in bundles {
            for subdirectory in subdirectories {
                if let bundled = bundle.url(
                    forResource: modelFileName,
                    withExtension: modelCompiledExtension,
                    subdirectory: subdirectory
                ) {
                    return bundled
                }
                if let bundled = bundle.url(
                    forResource: modelFileName,
                    withExtension: modelPackageExtension,
                    subdirectory: subdirectory
                ) {
                    return bundled
                }
            }
        }

        throw PoseModelError.modelNotFound
    }

    private static func loadModel(url: URL, configuration: MLModelConfiguration) throws -> MLModel {
        if url.pathExtension == modelCompiledExtension {
            return try MLModel(contentsOf: url, configuration: configuration)
        }
        let compiledURL = try MLModel.compileModel(at: url)
        return try MLModel(contentsOf: compiledURL, configuration: configuration)
    }

    private struct InputMapping: Sendable {
        let padX: Float
        let padY: Float
        let scaledWidth: Float
        let scaledHeight: Float
        let orientation: CGImagePropertyOrientation
    }

    private func prepareInput(
        pixelBuffer: CVPixelBuffer,
        orientation: CGImagePropertyOrientation
    ) throws -> (CVPixelBuffer, InputMapping) {
        let oriented = CIImage(cvPixelBuffer: pixelBuffer).oriented(orientation)
        let originalWidth = oriented.extent.width
        let originalHeight = oriented.extent.height

        let scale = min(CGFloat(inputWidth) / originalWidth, CGFloat(inputHeight) / originalHeight)
        let scaledWidth = originalWidth * scale
        let scaledHeight = originalHeight * scale
        let padX = (CGFloat(inputWidth) - scaledWidth) * 0.5
        let padY = (CGFloat(inputHeight) - scaledHeight) * 0.5

        let scaledImage = oriented.transformed(by: CGAffineTransform(scaleX: scale, y: scale))
        let translated = scaledImage.transformed(
            by: CGAffineTransform(
                translationX: padX - scaledImage.extent.origin.x,
                y: padY - scaledImage.extent.origin.y
            )
        )
        let background = CIImage(color: .black).cropped(
            to: CGRect(x: 0, y: 0, width: inputWidth, height: inputHeight)
        )
        let finalImage = translated.composited(over: background)

        let outputBuffer = try makeReusablePixelBuffer()
        let bounds = CGRect(x: 0, y: 0, width: inputWidth, height: inputHeight)
        ciContext.render(
            finalImage,
            to: outputBuffer,
            bounds: bounds,
            colorSpace: CGColorSpaceCreateDeviceRGB()
        )

        let mapping = InputMapping(
            padX: Float(padX),
            padY: Float(padY),
            scaledWidth: Float(scaledWidth),
            scaledHeight: Float(scaledHeight),
            orientation: orientation
        )

        return (outputBuffer, mapping)
    }

    private func makeReusablePixelBuffer() throws -> CVPixelBuffer {
        if let buffer = reusablePixelBuffer {
            return buffer
        }

        var buffer: CVPixelBuffer?
        let attributes: [String: Any] = [
            kCVPixelBufferPixelFormatTypeKey as String: inputPixelFormat,
            kCVPixelBufferWidthKey as String: inputWidth,
            kCVPixelBufferHeightKey as String: inputHeight,
            kCVPixelBufferBytesPerRowAlignmentKey as String: inputWidth * 4,
            kCVPixelBufferIOSurfacePropertiesKey as String: [:],
        ]

        let status = CVPixelBufferCreate(
            kCFAllocatorDefault,
            inputWidth,
            inputHeight,
            inputPixelFormat,
            attributes as CFDictionary,
            &buffer
        )

        guard status == kCVReturnSuccess, let created = buffer else {
            throw PoseModelError.invalidInput
        }

        reusablePixelBuffer = created
        return created
    }

    private struct MultiArrayData {
        let values: [Float]
        let shape: [Int]
        let strides: [Int]

        init(_ array: MLMultiArray) throws {
            shape = array.shape.map { $0.intValue }
            strides = array.strides.map { $0.intValue }
            switch array.dataType {
            case .float32:
                let pointer = array.dataPointer.bindMemory(to: Float.self, capacity: array.count)
                values = Array(UnsafeBufferPointer(start: pointer, count: array.count))
            case .float16:
                let pointer = array.dataPointer.bindMemory(to: UInt16.self, capacity: array.count)
                var output = [Float]()
                output.reserveCapacity(array.count)
                for i in 0..<array.count {
                    output.append(Float(Float16(bitPattern: pointer[i])))
                }
                values = output
            default:
                throw PoseModelError.invalidOutput
            }
        }

        func value(batch: Int, channel: Int, y: Int, x: Int) -> Float {
            if shape.count == 4 {
                let offset = batch * strides[0] + channel * strides[1] + y * strides[2] + x * strides[3]
                return values[offset]
            }
            if shape.count == 3 {
                let offset = channel * strides[0] + y * strides[1] + x * strides[2]
                return values[offset]
            }
            return 0
        }

        func dimensions4D() -> (batch: Int, channels: Int, height: Int, width: Int) {
            if shape.count == 4 {
                return (shape[0], shape[1], shape[2], shape[3])
            }
            if shape.count == 3 {
                return (1, shape[0], shape[1], shape[2])
            }
            return (1, 0, 0, 0)
        }
    }

    private func decodeOutput(
        _ features: MLFeatureProvider,
        mapping: InputMapping
    ) throws -> [Keypoint2D] {
        guard let heatmapsArray = features.featureValue(for: "heatmaps")?.multiArrayValue,
              let centersArray = features.featureValue(for: "centers")?.multiArrayValue,
              let regsArray = features.featureValue(for: "regs")?.multiArrayValue,
              let offsetsArray = features.featureValue(for: "offsets")?.multiArrayValue else {
            throw PoseModelError.invalidOutput
        }

        let heatmaps = try MultiArrayData(heatmapsArray)
        let centers = try MultiArrayData(centersArray)
        let regs = try MultiArrayData(regsArray)
        let offsets = try MultiArrayData(offsetsArray)

        let dims = heatmaps.dimensions4D()
        guard dims.channels >= jointOrder.count, dims.height > 0, dims.width > 0 else {
            throw PoseModelError.invalidOutput
        }

        let gridHeight = dims.height
        let gridWidth = dims.width
        let hasCenterWeight = Self.centerWeight.count == gridWidth * gridHeight

        var centerX = 0
        var centerY = 0
        var bestCenterValue = -Float.greatestFiniteMagnitude

        for y in 0..<gridHeight {
            for x in 0..<gridWidth {
                let value = centers.value(batch: 0, channel: 0, y: y, x: x)
                let weighted = hasCenterWeight ? value * Self.centerWeight[y * gridWidth + x] : value
                if weighted > bestCenterValue {
                    bestCenterValue = weighted
                    centerX = x
                    centerY = y
                }
            }
        }

        var output = [Keypoint2D]()
        output.reserveCapacity(jointOrder.count)

        for joint in 0..<jointOrder.count {
            let regXOrigin = Int(regs.value(batch: 0, channel: joint * 2, y: centerY, x: centerX) + 0.5)
            let regYOrigin = Int(regs.value(batch: 0, channel: joint * 2 + 1, y: centerY, x: centerX) + 0.5)
            let regXBase = regXOrigin + centerX
            let regYBase = regYOrigin + centerY

            var bestX = 0
            var bestY = 0
            var bestValue = -Float.greatestFiniteMagnitude

            for y in 0..<gridHeight {
                for x in 0..<gridWidth {
                    let heat = heatmaps.value(batch: 0, channel: joint, y: y, x: x)
                    if heat < Self.hmThreshold {
                        continue
                    }
                    let dx = Float(x - regXBase)
                    let dy = Float(y - regYBase)
                    let denom = (dx * dx + dy * dy).squareRoot() + 1.8
                    let value = heat / denom
                    if value > bestValue {
                        bestValue = value
                        bestX = x
                        bestY = y
                    }
                }
            }

            bestX = min(max(bestX, 0), gridWidth - 1)
            bestY = min(max(bestY, 0), gridHeight - 1)

            let score = max(0, heatmaps.value(batch: 0, channel: joint, y: bestY, x: bestX))
            if score < Self.hmThreshold {
                output.append(Keypoint2D(xNorm: 0.5, yNorm: 0.5, score: 0))
                continue
            }

            let offsetX = offsets.value(batch: 0, channel: joint * 2, y: bestY, x: bestX)
            let offsetY = offsets.value(batch: 0, channel: joint * 2 + 1, y: bestY, x: bestX)

            let xNorm = (Float(bestX) + offsetX) / Float(gridWidth)
            let yNorm = (Float(bestY) + offsetY) / Float(gridHeight)

            let mapped = mapToOriginal(
                xNorm: xNorm,
                yNorm: yNorm,
                mapping: mapping
            )

            output.append(
                Keypoint2D(
                    xNorm: clamp01(mapped.x),
                    yNorm: clamp01(mapped.y),
                    score: score
                )
            )
        }

        return output
    }

    private func mapToOriginal(xNorm: Float, yNorm: Float, mapping: InputMapping) -> (
        x: Float, y: Float
    ) {
        let inputX = xNorm * Float(inputWidth)
        let inputY = yNorm * Float(inputHeight)

        let unpaddedX = (inputX - mapping.padX) / max(mapping.scaledWidth, 0.0001)
        let unpaddedY = (inputY - mapping.padY) / max(mapping.scaledHeight, 0.0001)

        let orientedPoint = SIMD2<Float>(
            x: clamp01(unpaddedX),
            y: clamp01(unpaddedY)
        )

        let originalPoint = mapOrientedToOriginal(orientedPoint, orientation: mapping.orientation)
        return (clamp01(originalPoint.x), clamp01(originalPoint.y))
    }

    private func mapOrientedToOriginal(
        _ point: SIMD2<Float>,
        orientation: CGImagePropertyOrientation
    ) -> SIMD2<Float> {
        switch orientation {
        case .up:
            return point
        case .down:
            return SIMD2<Float>(x: 1 - point.x, y: 1 - point.y)
        case .left:
            return SIMD2<Float>(x: 1 - point.y, y: point.x)
        case .right:
            return SIMD2<Float>(x: point.y, y: 1 - point.x)
        case .upMirrored:
            return SIMD2<Float>(x: 1 - point.x, y: point.y)
        case .downMirrored:
            return SIMD2<Float>(x: point.x, y: 1 - point.y)
        case .leftMirrored:
            return SIMD2<Float>(x: point.y, y: point.x)
        case .rightMirrored:
            return SIMD2<Float>(x: 1 - point.y, y: 1 - point.x)
        @unknown default:
            return point
        }
    }

    private func clamp01(_ value: Float) -> Float {
        min(max(value, 0), 1)
    }
}
